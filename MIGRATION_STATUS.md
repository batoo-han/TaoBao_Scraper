# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL + Redis

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã PostgreSQL –∏ Redis –≤ `docker-compose.yml`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `requirements.txt` (SQLAlchemy, Alembic, asyncpg, redis, aioredis)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `.env.example` —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ë–î
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `src/core/config.py` —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ë–î

### 2. –ú–æ–¥–µ–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã SQLAlchemy –º–æ–¥–µ–ª–∏ –≤ `src/db/models.py`:
  - User
  - UserSettings
  - AccessControl
  - AccessListEntry
  - AdminSettings
  - RateLimitGlobal
  - RateLimitUser

### 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω `src/db/session.py` —Å async —Å–µ—Å—Å–∏—è–º–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω `src/db/redis_client.py` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis

### 4. –ú–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω Alembic (`alembic.ini`, `alembic/env.py`, `alembic/script.py.mako`)
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON –≤ –ë–î (`scripts/migrate_json_to_db.py`)

### 5. –°–µ—Ä–≤–∏—Å—ã
- ‚úÖ `AccessControlService` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ —Ä–∞–±–æ—Ç—É —Å PostgreSQL (`src/services/access_control.py`)
- ‚úÖ `UserSettingsService` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ —Ä–∞–±–æ—Ç—É —Å PostgreSQL (`src/services/user_settings.py`)

### 6. –°–∫—Ä–∏–ø—Ç—ã
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –±—ç–∫–∞–ø–∞/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î (`scripts/backup_db.sh`, `scripts/restore_db.sh`)
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π (`scripts/migrate_db.py`)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `scripts/deploy_fast.sh` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î

## üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ / –û—Å—Ç–∞–ª–æ—Å—å

### 1. –°–µ—Ä–≤–∏—Å—ã (—Ç—Ä–µ–±—É—é—Ç –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –Ω–∞ async + –ë–î)
- ‚ö†Ô∏è `RateLimitService` - —á–∞—Å—Ç–∏—á–Ω–æ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞)
- ‚ö†Ô∏è `AdminSettingsService` - –Ω–µ –Ω–∞—á–∞—Ç–æ

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ `src/bot/handlers.py` - –≤—Å–µ –≤—ã–∑–æ–≤—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ async
- ‚úÖ `src/webapp/server.py` - –≤—Å–µ –≤—ã–∑–æ–≤—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ async
- ‚úÖ `main.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î/Redis –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### 3. –ú–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è Alembic (`alembic/versions/001_initial_migration.py`)
- ‚ö†Ô∏è –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ migrate_json_to_db.py)

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚ö†Ô∏è `DATABASE_SETUP.md` - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ë–î
- ‚ö†Ô∏è `DEPLOYMENT.md` - –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é
- ‚ö†Ô∏è `MIGRATION_GUIDE.md` - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤:** –í–´–ü–û–õ–ù–ï–ù–û
   - ‚úÖ `RateLimitService` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ async + –ë–î
   - ‚úÖ `AdminSettingsService` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ async + –ë–î
   - ‚úÖ `UserSettingsService` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ async + –ë–î
   - ‚úÖ `AccessControlService` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ async + –ë–î

2. ‚úÖ **–û–±–Ω–æ–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤:** –í–´–ü–û–õ–ù–ï–ù–û
   - ‚úÖ –í—Å–µ –≤—ã–∑–æ–≤—ã –≤ `handlers.py` –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ async
   - ‚úÖ –í—Å–µ –≤—ã–∑–æ–≤—ã –≤ `server.py` –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ async
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î/Redis –≤ `main.py`

3. **–°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:**
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è Alembic
   - ‚ö†Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã –ë–î: `python scripts/migrate_db.py` –∏–ª–∏ `alembic upgrade head`
   - ‚ö†Ô∏è –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON: `python scripts/migrate_json_to_db.py`

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - ‚ö†Ô∏è –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞ —Å –Ω–æ–≤–æ–π –ë–î
   - ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
   - ‚ö†Ô∏è –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ —á–∏—Ç–∞—é—Ç—Å—è

5. **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:**
   - ‚ö†Ô∏è –°–æ–∑–¥–∞—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç —Å async, –ø–æ—ç—Ç–æ–º—É –≤—Å–µ –≤—ã–∑–æ–≤—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `await`
- –°—Ç–∞—Ä—ã–µ JSON —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ `scripts/migrate_json_to_db.py`
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `python scripts/migrate_db.py upgrade head`
- –ë—ç–∫–∞–ø—ã –ë–î —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
