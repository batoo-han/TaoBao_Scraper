## Szwego: интеграция API-парсинга в бот

### Что реализовано

- **Поддержка платформы `szwego`** в `URLParser` и в Telegram-хэндлере.
- **Парсинг товара через API** (без браузера) в `src/api/szwego_api.py`.
- Источник данных: **`GET /commodity/view`** с параметрами:
  - `targetAlbumId` = `shop_id` из URL
  - `itemId` = `goods_id` из URL
  - `transLang` = `SZWEGO_TRANS_LANG` (по умолчанию `en`)

### Почему нужен “токен”

Szwego требует авторизацию. В практике это выражается в том, что:
- нужно иметь **валидные cookies**
- среди них обычно есть критичная cookie **`token`** (это и есть “токен”)
- желательно передавать тот же **User-Agent**, из которого были экспортированы cookies

### Где хранить cookies

В проекте используется файл:
- `SZWEGO_COOKIES_FILE=cookies/szwego_cookies.json`

Файл содержит секреты и **не должен попадать в git**. Для примера есть шаблон:
- `cookies/szwego_cookies_example.json`

### Как обновлять cookies/UA на сервере

Это ручная операция (как вы и описали):

1. В браузере авторизуйтесь на Szwego.
2. Экспортируйте cookies для домена `szwego.com` (и поддоменов), и отдельно скопируйте `navigator.userAgent`.
3. Сформируйте JSON в формате как в `cookies/szwego_cookies_example.json`.
4. Загрузите файл на сервер по пути, указанному в `SZWEGO_COOKIES_FILE`.
5. Перезапустите контейнер/бота (если нужно).

### Автоматическая авторизация через бота

Добавлен сценарий авторизации через Telegram-бота:
- пользователь вводит логин/пароль;
- Playwright открывает страницу входа и решает слайдер-капчу локально;
- cookies и user-agent сохраняются в файл пользователя.

Подробности и список переменных окружения — в документе:
- `docs/SZWEGO_AUTH.md`

### Какие данные возвращает парсер

Мы приводим ответ Szwego к минимальному `product_data`, который ожидает наш пайплайн:

- `title` — название/описание (Szwego часто отдаёт многострочный текст в `title`)
- `details` — тот же текст (для контекста)
- `price` / `price_info.price`
- `main_imgs` / `detail_imgs`
- `product_url`
- `skus` — пустой список (в API-формате Szwego SKU обычно нет)

### Типичные ошибки и диагностика

- **401 / ошибка API**:
  - чаще всего это **протухшие cookies** (`token`, `JSESSIONID`) или несовпадение `User-Agent`
  - обновите cookies/UA и повторите
- **400 “не удалось извлечь shop_id и goods_id”**:
  - проверьте формат ссылки: для товара нужна `#/theme_detail/<shop_id>/<goods_id>`
  - ссылка вида `...#/shop_detail/...` — это страница магазина/альбома, а не конкретного товара

### Мониторинг “протухания” токена

В боте включён фоновый монитор Szwego (по умолчанию включён):
- проверяет `expires` у cookie `token` в файле `SZWEGO_COOKIES_FILE`
- при проблеме отправляет **уведомление админу** (если задан `ADMIN_CHAT_ID`)
- при пользовательском запросе, если токен протух — пользователю приходит сообщение: «Szwego временно недоступен. Попробуйте отправить запрос позже.» (без технических деталей), а LLM не вызывается

Переменные окружения:
- `SZWEGO_MONITOR_ENABLED` — включить/выключить монитор
- `SZWEGO_MONITOR_INTERVAL_SEC` — период проверки
- `SZWEGO_TOKEN_EXPIRY_WARN_SEC` — за сколько секунд до expires слать предупреждение админу
- `SZWEGO_ALERT_MIN_INTERVAL_SEC` — анти-спам интервал для алертов
- `SZWEGO_HEALTHCHECK_URL` — опционально: URL товара для реального API-пинга (если хотите проверять не только expires)



