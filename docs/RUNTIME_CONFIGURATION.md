# Runtime-конфигурация проекта

## Назначение

Новая система конфигурации позволяет централизованно управлять всеми настройками приложения через админ-панель и автоматически применять изменения без перезапуска, когда это возможно. Ключевые возможности:

- единый источник правды — таблица `app_settings` (постоянные значения) + таблица `runtime_settings` (эффективные значения на время работы);
- динамическое обновление настроек через `ConfigManager` без перезагрузки процессов;
- автоматическое отслеживание параметров, требующих перезапуска, и отображение уведомления в UI;
- поддержка резервного чтения из `.env`, если значения отсутствуют в базе.

## Структура

| Таблица/объект                | Описание                                                                              |
|------------------------------|---------------------------------------------------------------------------------------|
| `app_settings.app_config`    | Постоянные значения всех настроек (перекрывают `.env`).                               |
| `app_settings.pending_restart_config` | Значения, которые будут применены после перезапуска.                         |
| `runtime_settings`           | JSON-словарь с текущими эффективными значениями (обновляется через `ConfigManager`). |
| `ConfigManager`              | Класс, управляющий синхронизацией, типизацией и уведомлениями о перезапуске.          |

## Потоки обновления

1. **Инициализация** — при запуске `ConfigManager` формирует runtime-таблицу из `.env` + `app_settings` и обновляет глобальный объект `settings`.
2. **Изменение через админку** — эндпоинты вызывают `config_manager.update_settings_batch`, который:
   - обновляет `app_settings.app_config`;
   - переносит значения в `runtime_settings` (если не нужен перезапуск);
   - добавляет ключи в `pending_restart_config`, если требуется перезапуск;
   - обновляет объект `settings`, чтобы код бота видел свежее значение.
3. **Перезапуск** — при нажатии кнопки «Перезапустить сервисы» запускается скрипт `scripts/restart_services.py`, очищающий старые процессы и запускающий `run_all.py`. На старте новые значения подтягиваются автоматически.

## Рекомендации по разработке

- Для новых параметров добавляйте поле в `Settings` (`src/core/config.py`) и указывайте ключ в `ConfigManager.RESTART_REQUIRED_KEYS`, если требуется рестарт.
- Пользуйтесь сервисом `RuntimeSettingsService` для низкоуровневой работы с временной таблицей.
- Все изменения схем оформляйте миграциями Alembic (см. `alembic/versions/003_add_runtime_settings.py`).
- Если настройка влияет на внешние соединения (БД, порты, секреты JWT) — обязательно помечайте её как требующую перезапуск, чтобы UI отображал уведомление.

## Обслуживание

- Проверка текущей конфигурации: в админке (раздел «Настройки») или через SQL-запрос к `runtime_settings`/`app_settings`.
- Ручной перезапуск: `python scripts/restart_services.py`.
- Поиск «висящих» процессов: `python scripts/find_bot_processes.py --kill`.

Использование runtime-конфигурации гарантирует, что изменения настроек будут прозрачными для администраторов и не приведут к незапланированным простоям сервиса.

