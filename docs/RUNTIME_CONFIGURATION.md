# Runtime-конфигурация проекта

## Назначение

Новая система конфигурации позволяет централизованно управлять всеми настройками приложения через админ-панель и автоматически применять изменения без перезапуска, когда это возможно. Ключевые возможности:

- единый источник правды — таблица `app_settings` (постоянные значения) + таблица `runtime_settings` (эффективные значения на время работы);
- динамическое обновление настроек через `ConfigManager` без перезагрузки процессов;
- автоматическое отслеживание параметров, требующих перезапуска, и отображение уведомления в UI;
- поддержка резервного чтения из `.env`, если значения отсутствуют в базе.

## Структура

| Таблица/объект                | Описание                                                                              |
|------------------------------|---------------------------------------------------------------------------------------|
| `app_settings.app_config`    | Постоянные значения всех настроек (перекрывают `.env`).                               |
| `app_settings.pending_restart_config` | Значения, которые будут применены после перезапуска.                         |
| `runtime_settings`           | JSON-словарь с текущими эффективными значениями (обновляется через `ConfigManager`). |
| `ConfigManager`              | Класс, управляющий синхронизацией, типизацией и уведомлениями о перезапуске.          |

## Потоки обновления

1. **Инициализация** — при запуске `ConfigManager` формирует runtime-таблицу из `.env` + `app_settings` и обновляет глобальный объект `settings`.
2. **Изменение через админку** — эндпоинты вызывают `config_manager.update_settings_batch`, который:
   - обновляет `app_settings.app_config`;
   - переносит значения в `runtime_settings` (если не нужен перезапуск);
   - добавляет ключи в `pending_restart_config`, если требуется перезапуск;
   - обновляет объект `settings`, чтобы код бота видел свежее значение.
3. **Перезапуск** — при нажатии кнопки «Перезапустить сервисы» запускается скрипт `scripts/restart_services.py`, очищающий старые процессы и запускающий `run_all.py`. На старте новые значения подтягиваются автоматически.

## Новые настройки (OCR и анализ изображений)

| Ключ | Назначение | Требует перезапуск |
|------|------------|-------------------|
| `ENABLE_IMAGE_TEXT_ANALYSIS` | Включает/выключает модуль распознавания текста и таблиц на изображениях. | Нет |
| `YANDEX_VISION_API_KEY` | API ключ для сервиса Yandex Vision OCR. | Да |
| `YANDEX_VISION_FOLDER_ID` | Отдельный ID каталога Yandex Cloud для Vision (если отличается от YANDEX_FOLDER_ID). | Да |
| `YANDEX_VISION_MODEL` | Модель Yandex Vision для распознавания (`ocr`, `inline-text`). | Да |
| `IMAGE_TEXT_TRANSLATE_LANGUAGE` | Целевой язык перевода распознанного текста (`ru`, `en`). | Нет |
| `IMAGE_TEXT_LLM_VENDOR` | Провайдер LLM для анализа текста с изображений (`yandex`, `openai`, `proxiapi`). | Нет |
| `IMAGE_TEXT_LLM_MODEL` | Модель LLM для суммаризации текста с изображений. | Нет |
| `IMAGE_TEXT_LLM_PROMPT` | Промпт для анализа распознанного текста и таблиц. | Нет |
| `IMAGE_TEXT_LLM_TEMPERATURE` | Температура генерации для LLM анализа (0.0-1.0). | Нет |
| `IMAGE_TEXT_LLM_MAX_TOKENS` | Максимальное количество токенов в ответе LLM (1-4000). | Нет |
| `IMAGE_TEXT_OUTPUT_DIR` | Каталог для сохранения визуализированных таблиц (по умолчанию `data/image_analysis`). | Нет |

**Примечание:** Настройки LLM для анализа изображений независимы от глобальных настроек LLM для генерации описаний товаров.

## Рекомендации по разработке

- Для новых параметров добавляйте поле в `Settings` (`src/core/config.py`) и указывайте ключ в `ConfigManager.RESTART_REQUIRED_KEYS`, если требуется рестарт.
- Пользуйтесь сервисом `RuntimeSettingsService` для низкоуровневой работы с временной таблицей.
- Все изменения схем оформляйте миграциями Alembic (см. `alembic/versions/003_add_runtime_settings.py`).
- Если настройка влияет на внешние соединения (БД, порты, секреты JWT) — обязательно помечайте её как требующую перезапуск, чтобы UI отображал уведомление.

## Обслуживание

### Проверка конфигурации

**Через админ-панель:**
- Раздел «Настройки» → все вкладки с группировкой по назначению
- Раздел «LLM Провайдеры» → настройки провайдеров

**Через SQL:**
```sql
-- Текущие runtime настройки
SELECT * FROM runtime_settings;

-- Постоянные настройки
SELECT app_config, pending_restart_config FROM app_settings LIMIT 1;
```

### Перезапуск сервисов

**Через админ-панель:**
1. Раздел «Настройки» → кнопка «Перезапустить сервисы»
2. Система автоматически:
   - Завершит все процессы
   - Запустит новые экземпляры
   - Проверит переподключение
   - Обновит страницу

**Через командную строку:**
```bash
python scripts/restart_services.py
```

**Логи:**
- `logs/restart.log` - детальные логи перезапуска
- `logs/run_all_output.log` - вывод процесса `run_all.py`

### Устранение проблем

**Поиск зависших процессов:**
```bash
python scripts/find_bot_processes.py --kill
```

**Проверка логов:**
```bash
# Логи приложения
tail -f logs/app.log

# Логи перезапуска
tail -f logs/restart.log
```

### Автоматическое применение настроек

При инициализации `ConfigManager`:
1. Загружает настройки из `.env` (если нет в БД)
2. Применяет `pending_restart_config` к `runtime_settings` (если перезапуск уже выполнен)
3. Очищает `pending_restart_config`
4. Обновляет глобальный объект `settings`

Использование runtime-конфигурации гарантирует, что изменения настроек будут прозрачными для администраторов и не приведут к незапланированным простоям сервиса.

