# Дублирование постов в дополнительный канал/группу

## Назначение
Добавлена возможность автоматически публиковать каждый сгенерированный пост в отдельный канал или группу Telegram. Это полезно для витрины/архива товаров и для командного мониторинга активности бота.

## Архитектура
- Глобальная настройка канала хранится в `FORWARD_CHANNEL_ID` (env) и в `data/admin_settings.json`, управляется через Mimi App (админ-панель).
- Сервис `AdminSettingsService` синхронизирует значение с рантаймом (`settings.FORWARD_CHANNEL_ID`) и Mimi App.
- Отправка дубликата происходит в хэндлере `handle_product_link` после успешной генерации поста. Логика вынесена в `broadcast_post_to_channel()` с отдельными помощниками для фото/альбомов.
- Логирование событий (`broadcast_success`/`broadcast_failed`) через `_log_json` в `src/bot/handlers.py`.

## Бизнес-логика
- Если `FORWARD_CHANNEL_ID` пустой — дублирование отключено.
- Поддерживаются числовые ID каналов/групп и `@username`.
- Автоматическая нормализация ID: положительные ID > 1e9 автоматически преобразуются в отрицательные (формат для групп).
- Формат отправки идентичен выдаче пользователю: до 4 главных фото с подписью, остальной текст и хвост изображений партиями по 10. При падении альбома — отправляется текст.
- Ошибки дублирования не влияют на основной ответ пользователю.
- Перед отправкой выполняется проверка доступности чата и прав бота.

## Форматы ID для Telegram

### Для каналов:
- **@username** (рекомендуется): `@my_channel`
- **Числовой ID супергруппы**: `-1001234567890` (формат `-100` + ID)

### Для групп:
- **Числовой ID группы**: `-123456789` (отрицательное число)
- **Положительный ID**: `3018683678` — система автоматически преобразует в `-3018683678` для групп

### Как получить правильный ID:

**Вариант 1: Через бота @userinfobot**
1. Добавьте бота `@userinfobot` в вашу группу/канал
2. Отправьте команду `/start`
3. Бот покажет ID группы (например, `-1001234567890`)

**Вариант 2: Через @RawDataBot**
1. Добавьте бота `@RawDataBot` в вашу группу/канал
2. Отправьте любое сообщение
3. Найдите `"chat":{"id":-1001234567890}` в ответе

**Вариант 3: Через логи бота (если бот уже работает)**
1. Добавьте бота в группу и отправьте ему сообщение
2. В логах бота будет виден `chat_id` группы

## Руководство по настройке

### Шаг 1: Добавьте бота в группу/канал
1. Откройте Telegram и перейдите в вашу группу/канал
2. Добавьте бота как участника
3. **Важно**: Назначьте бота администратором с правами:
   - ✅ Отправка сообщений
   - ✅ Отправка медиа

### Шаг 2: Укажите ID канала/группы

**Через `.env` файл:**
```env
# Для группы с ID 3018683678 (будет автоматически преобразовано в -3018683678)
FORWARD_CHANNEL_ID=3018683678

# Или укажите отрицательный формат явно
FORWARD_CHANNEL_ID=-3018683678

# Для канала с username
FORWARD_CHANNEL_ID=@my_channel

# Для супергруппы
FORWARD_CHANNEL_ID=-1001234567890
```

**Через Mimi App:**
1. Откройте Mimi App (кнопка в настройках бота)
2. Перейдите в раздел "Опции работы бота"
3. Введите ID в поле "Канал для дублирования постов"
4. Нажмите "Сохранить опции"

### Шаг 3: Перезапустите бота (если изменяли .env)
Если настройка была изменена через `.env`, перезапустите бота.  
Если настройка была изменена через Mimi App, перезапуск не требуется — изменения применяются сразу.

## Проверка работы

1. Отправьте любую товарную ссылку боту
2. Убедитесь, что:
   - ✅ Сообщение пришло вам в личные сообщения
   - ✅ Сообщение продублировалось в указанный канал/группу с теми же фото/текстом
3. Если дублирование не работает:
   - Проверьте логи на наличие записей `broadcast_failed` или `broadcast_chat_not_found`
   - Убедитесь, что бот является администратором группы/канала
   - Убедитесь, что ID указан правильно

## Устранение неполадок

### Ошибка: "chat not found"
**Причины:**
- Бот не добавлен в группу/канал
- Указан неверный ID
- ID не преобразован в правильный формат

**Решение:**
- Убедитесь, что бот добавлен в группу/канал
- Для групп используйте отрицательный формат ID (или положительный — система преобразует автоматически)
- Попробуйте использовать `@username` вместо числового ID

### Ошибка: "chat member status is restricted" или "not enough rights"
**Причины:**
- Бот не является администратором
- У бота нет прав на отправку сообщений

**Решение:**
- Назначьте бота администратором группы/канала
- Дайте боту права на отправку сообщений и медиа

### Пост не дублируется, но ошибок в логах нет
**Причины:**
- `FORWARD_CHANNEL_ID` пустой или не указан
- Настройка не применилась

**Решение:**
- Проверьте значение `FORWARD_CHANNEL_ID` в `.env` или через Mimi App
- Перезапустите бота после изменения `.env`

