# Бизнес-правила

1.  **Входные данные**: Бот принимает только действительные URL-адреса страниц товаров с сайтов `taobao.com` и `tmall.com` (включая короткие ссылки `tb.cn`).

2.  **Источники данных**:
    *   **информация о товаре**: `tmapi.top` API является единственным источником данных о товарах.
    *   **генерация текста**: LLM провайдер выбирается через `DEFAULT_LLM` (`yandex` — YandexGPT, `openai` — OpenAI gpt-4o-mini/gpt-4.1-mini/gpt-4o/o4-mini/gpt-5.*).
    *   **переводы и агрегация SKU**: отдельный провайдер `TRANSLATE_PROVIDER` (по умолчанию равен `DEFAULT_LLM`). Разрешены значения `yandex` (Yandex Translate) и `openai` (любой JSON-совместимый GPT). Переменная `TRANSLATE_LLM` поддерживается для совместимости.
    *   **курс валют**: `v6.exchangerate-api.com` используется для получения курса CNY к RUB.

3.  **Формат ответа**: Ответ пользователю всегда отправляется в тот же чат, откуда пришел запрос. Ответ состоит из медиагруппы (альбома) с изображениями товара и одной текстовой подписи к ней.

4.  **Требования к содержанию поста**:
    *   текст поста генерируется выбранным LLM (YandexGPT или OpenAI) с единым промптом и валидацией.
    *   пост должен быть кратким, привлекательным и содержать ключевую информацию о товаре (название, краткое описание, размеры, цена).
    *   цена должна быть указана в юанях как указано по ссылке.
    *   пост должен содержать призыв к действию и релевантный хэштег.
    *   в самом низу поста должна содержаться оригинальная ссылка на товар в виде "Ссылка", где в текст ссылки зашита сама ссылка.

5.  **Управление секретами**: Все ключи API и токены должны храниться в файле `.env` и загружаться через `config.py`. Они не должны быть жестко закодированы в исходном коде.

6.  **Окружение**: Приложение должно быть готово к запуску как локально в виртуальном окружении Python, так и в виде Docker-контейнера.

7.  **Конвертация валют**: Поведение, связанное с валютой, контролируется флагом `CONVERT_CURRENCY` в файле `.env`.
    *   если `CONVERT_CURRENCY` установлен в `True`, цена в посте будет дополнительно сконвертирована и отображена в рублях (RUB) по текущему курсу.
    *   если `CONVERT_CURRENCY` установлен в `False`, цена будет отображаться только в юанях (CNY).

8. **Обработка цен**:
    *   бот собирает уникальные комбинации `props_names + sale_price` из `skus`.
    *   список единожды переводится на русский через `TRANSLATE_PROVIDER`, результат ожидается в формате JSON `[{"label": "...", "price": ...}]`.
    *   тот же провайдер получает краткое русское название товара и аггрегирует SKU по одинаковой цене, убирая несущественные различия.
    *   если выбранный `TRANSLATE_PROVIDER` не поддерживает структурированные ответы, включается fallback-алгоритм на Python (нормализация/очистка названий, подсчёт частот по ключевым словам).