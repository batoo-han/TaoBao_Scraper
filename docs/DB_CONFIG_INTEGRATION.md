# Интеграция настроек из БД

## Обзор

Настройки приложения теперь могут храниться в базе данных и применяться налету без перезагрузки приложения. Настройки из БД имеют приоритет над настройками из `.env` файла.

## Как это работает

### 1. При старте приложения

При запуске бота (`main.py`) автоматически загружаются настройки из БД:

```python
# В main.py
await config_manager.load_from_db()
```

Если настройки из БД загружены успешно, они перезаписывают значения из `.env`. Если загрузка не удалась (например, БД недоступна), используются настройки из `.env`.

### 2. При обновлении через админку

Когда администратор обновляет настройки через админ-панель:

1. Настройки сохраняются в БД (таблица `app_settings`, поле `app_config`)
2. Настройки применяются налету через `config_manager.update_settings_batch()`
3. Изменения вступают в силу немедленно, без перезагрузки

### 3. При следующей перезагрузке

При следующем запуске приложения настройки из БД автоматически загружаются и применяются.

## Структура настроек в БД

Настройки хранятся в JSONB поле `app_config` таблицы `app_settings`:

```json
{
  "BOT_TOKEN": "...",
  "YANDEX_GPT_API_KEY": "...",
  "DEBUG_MODE": false,
  "ADMIN_PANEL_PORT": 8004,
  ...
}
```

## API Endpoints

### Обновить настройки

```http
PUT /api/admin/settings/app-config
Content-Type: application/json
Authorization: Bearer <token>

{
  "config": {
    "BOT_TOKEN": "новый_токен",
    "DEBUG_MODE": true
  }
}
```

### Перезагрузить настройки из БД

```http
POST /api/admin/config/reload
Authorization: Bearer <token>
```

## Преобразование типов

`ConfigManager` автоматически преобразует значения из БД в нужные типы:

- **bool**: Принимает строки `"true"`, `"1"`, `"yes"`, `"on"` или булевы значения
- **int**: Преобразует строки в целые числа
- **str**: Все остальные значения преобразуются в строки

## Обработка ошибок

- Если загрузка из БД не удалась, приложение продолжает работу с настройками из `.env`
- Если обновление налету не удалось, настройки все равно сохраняются в БД и применятся при следующей перезагрузке
- Все ошибки логируются для отладки

## Важные замечания

1. **Приоритет настроек**: БД > .env
2. **Не все настройки можно обновить налету**: Некоторые настройки (например, `BOT_TOKEN`) требуют перезагрузки приложения для полного применения
3. **Безопасность**: Настройки в БД должны быть защищены так же, как и `.env` файл
4. **Резервное копирование**: Рекомендуется регулярно делать бэкап таблицы `app_settings`

## Пример использования

```python
from src.core.config_manager import config_manager

# Загрузить настройки из БД
await config_manager.load_from_db()

# Обновить одну настройку
await config_manager.update_setting("DEBUG_MODE", True)

# Обновить несколько настроек
await config_manager.update_settings_batch({
    "DEBUG_MODE": True,
    "ADMIN_PANEL_PORT": 8005
})

# Проверить, загружены ли настройки из БД
if config_manager.db_config_loaded:
    print("Настройки из БД загружены")
```

