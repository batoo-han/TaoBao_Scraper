# Быстрый деплой (long polling) с простоем ≤ 10–20 c

Сценарий: бот работает на long polling, хотим обновлять контейнер почти без простоя, без вебхуков и blue/green.

## Что делает скрипт
`scripts/deploy_fast.sh`:
1. (Опционально) `docker compose pull` образ (если тянете из реестра, включите `DO_PULL=1`).
2. (По умолчанию) `docker compose build --pull` — собирает образ локально с обновлёнными базовыми слоями. Отключите через `SKIP_BUILD=1`, если образ уже собран.
3. `docker compose up -d --no-deps taobao-bot` — пересоздаёт только контейнер бота.
4. Ждёт `healthcheck` контейнера (см. `docker-compose.yml`), таймаут 90 c.

Простой ограничивается временем пересоздания контейнера и прогрева healthcheck (обычно 2–10 c на тёплой машине, укладывается в 10–20 c).

## Требования
- Docker Compose v2
- Настроенный `.env`
- Открытый порт Mini App (`MINI_APP_PORT`, по умолчанию 8081) — используется только для healthcheck внутри контейнера
- Python внутри контейнера (есть по умолчанию)

## Быстрый запуск
```bash
cd /path/to/TaoBao_Scraper
bash scripts/deploy_fast.sh
```

## Переменные управления
- `SKIP_BUILD=1` — пропустить сборку, использовать уже готовый образ.
- `DO_PULL=1` — перед сборкой подтянуть свежие слои/образ из реестра.
- `COMPOSE_FILE=...` — путь к compose-файлу (по умолчанию `docker-compose.yml`).
- `SERVICE=taobao-bot` — имя сервиса (по умолчанию `taobao-bot`).
- `HEALTH_TIMEOUT=90` — таймаут ожидания healthcheck в секундах.

Примеры:
```bash
# 1) Полный цикл (pull+build+up) — минимальный простой, но дольше готовим образ
DO_PULL=1 bash scripts/deploy_fast.sh

# 2) Образ уже собран/запушен — быстрый перезапуск
SKIP_BUILD=1 DO_PULL=1 bash scripts/deploy_fast.sh

# 3) Кастомный compose-файл
COMPOSE_FILE=docker-compose.prod.yml bash scripts/deploy_fast.sh
```

## Что добавлено в docker-compose
- `stop_grace_period: 10s` — корректное завершение при рестарте.
- `healthcheck`:
  - Проверяет `http://127.0.0.1:${MINI_APP_PORT}${MINI_APP_BASE_PATH}/health`
  - Интервал 15 c, таймаут 5 c, 5 попыток, стартовый период 10 c.
  - Используется скриптом, чтобы дождаться готовности нового контейнера.

## Советы по сокращению простоя
- Держите образ собранным заранее (`SKIP_BUILD=1`), если хватает диска — тогда `up -d` самый быстрый.
- Сведите миграции к минимуму; если они нужны — выполняйте отдельно перед рестартом.
- Следите, чтобы зависимости были в образе (не ставились при запуске).
- Логи и `data/` остаются томами, поэтому пересоздание контейнера не трогает данные.

## Откат
Если healthcheck не прошёл — контейнер останется в ошибочном состоянии. Можно быстро вернуть предыдущий образ:
```bash
# если старый образ ещё локально
docker compose up -d --no-deps taobao-bot

# либо указать тег предыдущей версии
IMAGE_TAG=prevtag docker compose up -d --no-deps taobao-bot
```

