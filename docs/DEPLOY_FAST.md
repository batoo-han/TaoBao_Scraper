# Быстрый деплой (long polling) с простоем ≤ 10–20 c

Сценарий: бот работает на long polling, хотим обновлять контейнер почти без простоя, без вебхуков и blue/green.

## Что делает скрипт
`scripts/deploy_fast.sh`:
1. (Опционально) `docker compose pull` образ (если тянете из реестра, включите `DO_PULL=1`).
2. (По умолчанию) `docker compose build --pull` — собирает образ локально с обновлёнными базовыми слоями. Отключите через `SKIP_BUILD=1`, если образ уже собран.
3. `docker compose up -d --no-deps taobao-bot` — пересоздаёт только контейнер бота.
4. Ждёт `healthcheck` контейнера (см. `docker-compose.yml`), таймаут 90 c.

Простой ограничивается временем пересоздания контейнера и прогрева healthcheck (обычно 2–10 c на тёплой машине, укладывается в 10–20 c).

## Требования
- Docker Compose v2
- Настроенный `.env`
- Открытый порт Mini App (`MINI_APP_PORT`, по умолчанию 8081) — используется только для healthcheck внутри контейнера
- Python внутри контейнера (есть по умолчанию)
- Переменная `PRICE_MODE` для выбора сценария цен (`simple` по умолчанию, `advanced` — сводка цен по SKU)

## Быстрый запуск
```bash
cd /path/to/TaoBao_Scraper
bash scripts/deploy_fast.sh
```

## Переменные управления
- `SKIP_BUILD=1` — пропустить сборку, использовать уже готовый образ.
- `DO_PULL=1` — перед сборкой подтянуть свежие слои/образ из реестра (может вызвать проблемы с сетью/Docker Hub).
- `COMPOSE_FILE=...` — путь к compose-файлу (по умолчанию `docker-compose.yml`).
- `SERVICE=taobao-bot` — имя сервиса (по умолчанию `taobao-bot`).
- `HEALTH_TIMEOUT=90` — таймаут ожидания healthcheck в секундах.

**Важно:** По умолчанию скрипт использует локальный базовый образ (без `--pull`), чтобы избежать проблем с сетью и доступом к Docker Hub. Используйте `DO_PULL=1` только если уверены в стабильном подключении к Docker Hub.

Примеры:
```bash
# 1) Стандартный деплой (локальный образ, без обновления базового слоя)
bash scripts/deploy_fast.sh

# 2) С обновлением базового образа из Docker Hub (требует стабильного подключения)
DO_PULL=1 bash scripts/deploy_fast.sh

# 3) Образ уже собран — быстрый перезапуск без сборки
SKIP_BUILD=1 bash scripts/deploy_fast.sh

# 4) Кастомный compose-файл
COMPOSE_FILE=docker-compose.prod.yml bash scripts/deploy_fast.sh
```

## Решение проблем с сетью

Если возникает ошибка подключения к Docker Hub (например, `network is unreachable` при IPv6):
1. **Используйте стандартный режим** (без `DO_PULL=1`) — скрипт использует локально кэшированный образ
2. Если нужно обновить базовый образ, проверьте подключение к Docker Hub:
   ```bash
   docker pull python:3.11-slim
   ```
3. Для принудительного использования IPv4 добавьте в `/etc/docker/daemon.json`:
   ```json
   {
     "ipv6": false
   }
   ```
   Затем перезапустите Docker: `systemctl restart docker`

## Что добавлено в docker-compose
- `stop_grace_period: 10s` — корректное завершение при рестарте.
- `healthcheck`:
  - Проверяет `http://127.0.0.1:${MINI_APP_PORT}${MINI_APP_BASE_PATH}/health`
  - Интервал 15 c, таймаут 5 c, 5 попыток, стартовый период 10 c.
  - Используется скриптом, чтобы дождаться готовности нового контейнера.

## Советы по сокращению простоя
- Держите образ собранным заранее (`SKIP_BUILD=1`), если хватает диска — тогда `up -d` самый быстрый.
- Сведите миграции к минимуму; если они нужны — выполняйте отдельно перед рестартом.
- Следите, чтобы зависимости были в образе (не ставились при запуске).
- Логи и `data/` остаются томами, поэтому пересоздание контейнера не трогает данные.

## Откат
Если healthcheck не прошёл — контейнер останется в ошибочном состоянии. Можно быстро вернуть предыдущий образ:
```bash
# если старый образ ещё локально
docker compose up -d --no-deps taobao-bot

# либо указать тег предыдущей версии
IMAGE_TAG=prevtag docker compose up -d --no-deps taobao-bot
```

